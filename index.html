<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Painting Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0c0c0c, #1a1a1a);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .header {
            padding: 15px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 20px;
            font-size: 14px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
            min-width: 100px;
        }

        button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            position: relative;
        }

        canvas {
            max-width: 100%;
            max-height: 80vh;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            touch-action: none;
        }

        .painting-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 200px;
            backdrop-filter: blur(5px);
        }

        .brush-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .brush-preview-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 5px auto;
            border: 2px solid white;
        }

        .frequency-display {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }

        .freq-bar {
            width: 3px;
            background: linear-gradient(to top, #ff4757, #ffa502, #2ed573, #1e90ff, #5352ed);
            border-radius: 2px;
            min-height: 5px;
            transition: height 0.1s ease;
        }

        @media (max-width: 768px) {
            .painting-info {
                position: static;
                margin: 10px;
                max-width: none;
            }
            
            .brush-preview {
                position: static;
                margin: 10px;
                display: inline-block;
            }
            
            .frequency-display {
                bottom: 10px;
                padding: 6px;
            }
            
            .freq-bar {
                width: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎨 Sound Painting</h1>
        <div class="status" id="status">
            <span>🎤 Tap "Start Painting" to enable microphone and create art with sound</span>
        </div>
        
        <div class="controls">
            <button id="startBtn">Start Painting</button>
            <button id="pauseBtn" disabled>Pause</button>
            <button id="saveBtn">Save Art</button>
            <button id="clearBtn">New Canvas</button>
        </div>
    </div>

    <div class="painting-info">
        <strong>🎵 Sound → Paint:</strong><br>
        • Bass = Warm colors (red/orange)<br>
        • Mid = Nature colors (green/yellow)<br>
        • Treble = Cool colors (blue/purple)<br>
        • Volume = Brush size<br>
        • Tempo = Paint density
    </div>

    <div class="canvas-container">
        <canvas id="paintingCanvas" width="800" height="600"></canvas>
        
        <div class="brush-preview">
            <div>Current Brush:</div>
            <div class="brush-preview-circle" id="brushPreview"></div>
            <div id="brushSize">Size: 5px</div>
        </div>
    </div>

    <div class="frequency-display" id="freqDisplay"></div>

    <script>
        class SoundPaintingGenerator {
            constructor() {
                this.canvas = document.getElementById('paintingCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.audioContext = null;
                this.analyser = null;
                this.microphone = null;
                this.dataArray = null;
                this.isListening = false;
                
                // Painting state
                this.paintX = 0;
                this.paintY = 0;
                this.lastPaintTime = 0;
                this.paintDirection = Math.random() * Math.PI * 2;
                
                this.setupElements();
                this.setupEventListeners();
                this.setupFrequencyDisplay();
                this.initializeCanvas();
                this.animate();
            }

            setupElements() {
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.saveBtn = document.getElementById('saveBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.status = document.getElementById('status');
                this.brushPreview = document.getElementById('brushPreview');
                this.brushSizeDisplay = document.getElementById('brushSize');
            }

            setupEventListeners() {
                this.startBtn.addEventListener('click', () => this.startListening());
                this.pauseBtn.addEventListener('click', () => this.pauseListening());
                this.saveBtn.addEventListener('click', () => this.savePainting());
                this.clearBtn.addEventListener('click', () => this.clearCanvas());
                
                // Handle window resize
                window.addEventListener('resize', () => this.handleResize());
            }

            setupFrequencyDisplay() {
                const freqDisplay = document.getElementById('freqDisplay');
                for (let i = 0; i < 32; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'freq-bar';
                    bar.style.height = '5px';
                    freqDisplay.appendChild(bar);
                }
            }

            initializeCanvas() {
                // Set canvas to white background
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Initialize painting position
                this.paintX = this.canvas.width / 2;
                this.paintY = this.canvas.height / 2;
            }

            handleResize() {
                // Maintain canvas aspect ratio on mobile
                const container = this.canvas.parentElement;
                const containerRect = container.getBoundingClientRect();
                const maxWidth = containerRect.width - 30;
                const maxHeight = window.innerHeight * 0.6;
                
                const scale = Math.min(maxWidth / 800, maxHeight / 600);
                this.canvas.style.width = (800 * scale) + 'px';
                this.canvas.style.height = (600 * scale) + 'px';
            }

            async startListening() {
                try {
                    this.status.textContent = "🎤 Requesting microphone access...";
                    
                    // Check if mediaDevices is supported
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('MediaDevices API not supported');
                    }
                    
                    // More permissive audio constraints for mobile
                    const constraints = {
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: false,
                            autoGainControl: false,
                            sampleRate: 44100,
                            channelCount: 1
                        }
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Create audio context with better mobile support
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContext({
                        sampleRate: 44100,
                        latencyHint: 'interactive'
                    });
                    
                    // Resume context if suspended (common on mobile)
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                    
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 2048; // Larger for better frequency resolution
                    this.analyser.smoothingTimeConstant = 0.6;
                    this.analyser.minDecibels = -90;
                    this.analyser.maxDecibels = -10;
                    
                    this.microphone = this.audioContext.createMediaStreamSource(stream);
                    this.microphone.connect(this.analyser);
                    
                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    this.stream = stream; // Keep reference to stop it later
                    
                    this.isListening = true;
                    this.status.textContent = "🎨 Painting with sound... Make noise to create art!";
                    
                    this.startBtn.disabled = true;
                    this.pauseBtn.disabled = false;
                    
                    // Test audio input
                    setTimeout(() => {
                        if (this.isListening) {
                            this.analyser.getByteFrequencyData(this.dataArray);
                            const hasInput = this.dataArray.some(val => val > 0);
                            if (!hasInput) {
                                this.status.textContent = "🎤 Microphone connected - try speaking or making sounds!";
                            }
                        }
                    }, 2000);
                    
                } catch (error) {
                    console.error('Microphone error:', error);
                    
                    if (error.name === 'NotAllowedError') {
                        this.status.textContent = "❌ Microphone permission denied. Please allow access and refresh.";
                    } else if (error.name === 'NotFoundError') {
                        this.status.textContent = "❌ No microphone found. Please check your device.";
                    } else if (error.name === 'NotSupportedError') {
                        this.status.textContent = "❌ Microphone not supported on this browser.";
                    } else {
                        this.status.textContent = "❌ Microphone access failed. Try refreshing the page.";
                    }
                    
                    // Show mobile-specific instructions
                    if (/Mobile|Android|iPhone|iPad/.test(navigator.userAgent)) {
                        setTimeout(() => {
                            this.status.textContent += " On mobile: ensure microphone permission is enabled in browser settings.";
                        }, 3000);
                    }
                }
            }

            pauseListening() {
                this.isListening = false;
                
                if (this.microphone) {
                    this.microphone.disconnect();
                    this.microphone = null;
                }
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                if (this.audioContext && this.audioContext.state !== 'closed') {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                
                this.status.textContent = "⏸️ Painting paused";
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
            }

            savePainting() {
                const link = document.createElement('a');
                link.download = `sound-painting-${Date.now()}.png`;
                link.href = this.canvas.toDataURL();
                link.click();
                
                this.status.textContent = "💾 Painting saved!";
                setTimeout(() => {
                    this.status.textContent = this.isListening ? 
                        "🎨 Painting with sound..." : "⏸️ Painting paused";
                }, 2000);
            }

            clearCanvas() {
                this.initializeCanvas();
                this.status.textContent = "🆕 New canvas ready!";
                setTimeout(() => {
                    this.status.textContent = this.isListening ? 
                        "🎨 Painting with sound..." : "Click 'Start Painting' to begin";
                }, 2000);
            }

            getColorFromFrequency(freqIndex, amplitude) {
                const normalizedFreq = freqIndex / this.dataArray.length;
                let r, g, b;
                
                if (normalizedFreq < 0.33) {
                    // Bass frequencies - warm colors
                    const bassIntensity = normalizedFreq / 0.33;
                    r = Math.floor(255 * (0.8 + bassIntensity * 0.2));
                    g = Math.floor(amplitude * (0.3 + bassIntensity * 0.4));
                    b = Math.floor(amplitude * 0.2);
                } else if (normalizedFreq < 0.66) {
                    // Mid frequencies - nature colors
                    const midIntensity = (normalizedFreq - 0.33) / 0.33;
                    r = Math.floor(amplitude * (0.8 - midIntensity * 0.5));
                    g = Math.floor(255 * (0.6 + midIntensity * 0.4));
                    b = Math.floor(amplitude * (0.2 + midIntensity * 0.3));
                } else {
                    // Treble frequencies - cool colors
                    const trebleIntensity = (normalizedFreq - 0.66) / 0.34;
                    r = Math.floor(amplitude * (0.3 - trebleIntensity * 0.2));
                    g = Math.floor(amplitude * (0.4 + trebleIntensity * 0.3));
                    b = Math.floor(255 * (0.7 + trebleIntensity * 0.3));
                }
                
                return `rgba(${r}, ${g}, ${b}, ${Math.max(0.3, amplitude / 255)})`;
            }

            paintPixels() {
                if (!this.isListening || !this.dataArray) return;
                
                this.analyser.getByteFrequencyData(this.dataArray);
                
                // Calculate overall energy
                let totalEnergy = 0;
                let dominantFreq = 0;
                let maxAmplitude = 0;
                
                for (let i = 0; i < this.dataArray.length; i++) {
                    const amplitude = this.dataArray[i];
                    totalEnergy += amplitude;
                    if (amplitude > maxAmplitude) {
                        maxAmplitude = amplitude;
                        dominantFreq = i;
                    }
                }
                
                if (totalEnergy < 500) return; // Noise threshold
                
                // Paint brush size based on volume
                const brushSize = Math.max(2, (maxAmplitude / 255) * 25);
                
                // Paint color based on dominant frequency
                const paintColor = this.getColorFromFrequency(dominantFreq, maxAmplitude);
                
                // Update brush preview
                this.brushPreview.style.background = paintColor;
                this.brushSizeDisplay.textContent = `Size: ${Math.round(brushSize)}px`;
                
                // Paint movement based on frequency content
                const freqSpread = this.dataArray.slice(0, 8).reduce((a, b) => a + b, 0);
                this.paintDirection += (Math.random() - 0.5) * (freqSpread / 2000);
                
                const moveDistance = (totalEnergy / 10000) * 15;
                this.paintX += Math.cos(this.paintDirection) * moveDistance;
                this.paintY += Math.sin(this.paintDirection) * moveDistance;
                
                // Keep within canvas bounds
                this.paintX = Math.max(brushSize, Math.min(this.canvas.width - brushSize, this.paintX));
                this.paintY = Math.max(brushSize, Math.min(this.canvas.height - brushSize, this.paintY));
                
                // Paint the brush stroke
                this.ctx.save();
                this.ctx.globalCompositeOperation = 'multiply';
                this.ctx.fillStyle = paintColor;
                this.ctx.beginPath();
                this.ctx.arc(this.paintX, this.paintY, brushSize / 2, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Add some texture with smaller dots
                for (let i = 0; i < 3; i++) {
                    const offsetX = (Math.random() - 0.5) * brushSize;
                    const offsetY = (Math.random() - 0.5) * brushSize;
                    this.ctx.beginPath();
                    this.ctx.arc(this.paintX + offsetX, this.paintY + offsetY, Math.random() * brushSize / 4, 0, Math.PI * 2);
                    this.ctx.fill();
                }
                
                this.ctx.restore();
            }

            updateFrequencyDisplay() {
                if (!this.isListening || !this.dataArray) return;
                
                const bars = document.querySelectorAll('.freq-bar');
                const step = Math.floor(this.dataArray.length / bars.length);
                
                bars.forEach((bar, i) => {
                    const value = this.dataArray[i * step] || 0;
                    const height = Math.max(5, (value / 255) * 40);
                    bar.style.height = height + 'px';
                });
            }

            animate() {
                this.paintPixels();
                this.updateFrequencyDisplay();
                requestAnimationFrame(() => this.animate());
            }
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            new SoundPaintingGenerator();
        });
    </script>
</body>
</html>